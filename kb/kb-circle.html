<dom-module id="kb-circle">
  <template>
    <style>
    :host {
      display: inline-block;
      width: 50px;
      height: 50px;
      overflow: hidden;
      margin: -2px;
    }
    #container {
      display: block;
      background-color: var(--circle-color);
      border-radius: 100%;
      box-sizing: border-box;
      width: 100%;
      height: 100%;
      cursor: pointer;
      overflow: hidden;
    }
    line {
      stroke: #181818;
      stroke-width: 2px;
    }
    </style>
    <div id="container" on-click="_spin">
      <svg height="50" width="50">
        <g>
          <line x1="25" y1="0" x2="25" y2="25" stroke-linecap="round"/>
          <line x1="25" y1="25" x2="0" y2="25" stroke-linecap="round"/>
        </g>
      </svg>
    </div>
  </template>
  <script>
    class KbCircle extends Polymer.Element {
      static get is() {
        return "kb-circle";
      }
      static get properties() {
        return {
          x: {
            type: Number,
            value: 0
          },
          y: {
            type: Number,
            value: 0
          },
          lock: {
            type: Boolean,
            value: false
          },
          currentPosition: Number,
          positions: {
            type: Array,
            value: () => [ 90, 180, 270, 360 ]
          },
          currentColor: Number,
          colors: {
            type: Array,
            value: () => [
              '#4caf50',//green
              '#ffeb3b',//yellow
              '#3f51b5',//purple
              '#ff9800',//orange
              '#f44336'//red
            ]
          }
        }
      }
      _spin(e) {
        if(!this.lock) {
          console.log(this.x, this.y);
          console.log(this.currentColor, this.currentPosition);

          this.lock = true;
          TweenLite.to(this.$.container, 0.2, {
            rotation: "+=90",
            ease: Linear.easeNone,
            onComplete: () => {
              this.currentPosition == 3 ? this.currentPosition = 0 : this.currentPosition++;
              this.sendSpinvalues();
              this.lock = false;
            }
          });
        }
      }
      changeSpinRandom() {
        const randomIndex = Math.floor((Math.random() * 4) + 0);
        TweenLite.to(this.$.container, 0.35, {
          rotation: `+=${this.positions[randomIndex]}`,
          ease: Linear.easeNone
        });
        this.currentPosition = randomIndex;
      }
      changeColorRandom() {
        const randomIndex = Math.floor((Math.random() * 5) + 0);
        this.changeColor(randomIndex);
      }
      changeColor(index) {
        this.updateStyles({'--circle-color': this.colors[index]});
        this.currentColor = index;
      }
      starAsRandom() {
        this.changeColorRandom();
        this.changeSpinRandom();
      }
      sendSpinvalues() { //TODO: Validar los limites
        const topAddress = `circle-${this.x}-${this.y-1}-listener`;
        const leftAddress = `circle-${this.x-1}-${this.y}-listener`;
        const bottomAddress = `circle-${this.x}-${this.y+1}-listener`;
        const rightAddress = `circle-${this.x+1}-${this.y}-listener`;
        const detail = {detail: {
          color: this.currentColor,
          position: this.currentPosition
        }};
        document.dispatchEvent(new CustomEvent(topAddress, detail));
        document.dispatchEvent(new CustomEvent(leftAddress, detail));
        document.dispatchEvent(new CustomEvent(bottomAddress, detail));
        document.dispatchEvent(new CustomEvent(rightAddress, detail));
      }
      setListener() {
        const address = `circle-${this.x}-${this.y}-listener`;
        document.addEventListener(address, (e) => {
          console.log(address, e.detail);
          const data = e.detail;
          this.changeColor(data.color);
        });
      }
      ready() {
        super.ready();
        this.starAsRandom();
        this.setListener();
      }
    }
    customElements.define(KbCircle.is, KbCircle);
  </script>
</dom-module>
